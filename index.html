<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานผลการเรียนรู้รายปี NSR</title>
    
    <!-- CSS Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Config Tailwind Theme -->
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#4f46e5',
                            secondary: '#64748b',
                            success: '#10b981', /* Emerald 500 */
                            danger: '#ef4444', /* Red 500 */
                        },
                        fontFamily: {
                            sans: ['Sarabun', 'sans-serif'],
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #f8fafc; 
            font-family: 'Sarabun', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Table Styling */
        .table-row-hover:hover { background-color: #eff6ff; /* blue-50 */ transition: background-color 0.15s; }
        .sticky-col { position: sticky; z-index: 10; background-color: white; }
        .table-row-hover:hover .sticky-col { background-color: #eff6ff; }

        /* Inputs */
        .input-base {
            @apply w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border p-2 transition-colors;
        }

        /* Print Styles - Optimized for Single Page A4 */
        @media print {
            @page { 
                size: A4; 
                margin: 0; 
            }
            body { 
                background: white !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                overflow: hidden !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .no-print, header, aside, .nav-controls { display: none !important; }
            
            #view-report { 
                display: block !important; 
                position: absolute !important; 
                top: 0 !important;
                left: 0 !important;
                width: 100% !important; 
                height: 100% !important;
                margin: 0 !important; 
                padding: 0 !important;
                background: white !important;
            }
            
            .a4-page { 
                width: 210mm !important; 
                height: 296mm !important; /* Force A4 Height */
                max-width: none !important; 
                padding: 10mm 15mm !important; 
                margin: 0 !important; 
                box-shadow: none !important;
                border: none !important; 
                transform: none !important;
                background: white !important;
            }
            
            /* Compact Content for Single Page */
            .a4-page h1 { font-size: 16pt !important; margin-bottom: 4px !important; }
            .a4-page h2 { font-size: 14pt !important; margin-bottom: 4px !important; }
            .a4-page h3 { font-size: 12pt !important; margin-bottom: 8px !important; }
            
            /* Table Adjustments */
            .a4-page table { width: 100% !important; border-collapse: collapse !important; margin-bottom: 10px !important; }
            .a4-page th, .a4-page td { 
                border: 1px solid #333 !important; 
                padding: 4px 6px !important; 
                font-size: 11pt !important; 
            }
            .a4-page th { font-weight: bold !important; background-color: #f3f4f6 !important; } 

            /* Info Text Sizes */
            .a4-page .text-base { font-size: 11pt !important; }
            .a4-page .text-xl { font-size: 14pt !important; }
            .a4-page .text-lg { font-size: 12pt !important; }
            
            /* Signature Tuning */
            .signature-section { margin-top: 1cm !important; }
            .signature-line { border-bottom: 1px dotted #000 !important; }
        }

        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Top Navbar -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-50 no-print flex-shrink-0 h-16">
        <div class="h-full px-4 sm:px-6 lg:px-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-none">ระบบรายงานผลการเรียนรู้รายปี ป.3/2</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="text-[10px] text-slate-500 font-medium">หลักสูตรการศึกษาประถมศึกษาตอนต้น (ป.1-3) พุทธศักราช 2568</span>
                        <!-- Cloud Save Status -->
                        <span id="cloud-status" class="hidden text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-400">
                            <i class="fas fa-cloud"></i> <span id="cloud-status-text">Cloud Standby</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                 <!-- Cloud Save (Google Sheets) -->
                 <button onclick="setupCloudConnection()" id="btn-cloud-connect" class="flex items-center gap-2 bg-white text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-50 transition shadow-sm mr-2" title="ตรวจสอบสถานะ">
                    <i class="fab fa-google-drive text-sm"></i> สถานะ Cloud
                </button>

                <!-- Data Management Group -->
                <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                    <button onclick="backupData()" class="flex items-center gap-2 px-3 py-1.5 text-xs font-bold text-slate-600 hover:text-indigo-600 hover:bg-white rounded-md transition shadow-sm hover:shadow">
                        <i class="fas fa-download"></i> สำรองข้อมูล
                    </button>
                    <div class="w-px bg-slate-300 mx-1 my-1"></div>
                    <button onclick="document.getElementById('restore-upload').click()" class="flex items-center gap-2 px-3 py-1.5 text-xs font-bold text-slate-600 hover:text-purple-600 hover:bg-white rounded-md transition shadow-sm hover:shadow">
                        <i class="fas fa-upload"></i> กู้คืนข้อมูล
                    </button>
                    <input type="file" id="restore-upload" accept=".json" class="hidden" onchange="handleRestore(event)">
                </div>

                <!-- Export Group -->
                <button onclick="exportToCSV()" class="ml-2 flex items-center gap-2 bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition shadow-sm hover:shadow-md border border-emerald-700">
                    <i class="fas fa-file-csv text-sm"></i> ส่งออก Excel
                </button>

                <!-- Reset -->
                <button onclick="resetData()" class="ml-2 flex items-center gap-2 bg-white text-red-600 border border-red-200 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-50 transition">
                    <i class="fas fa-trash-alt"></i> Reset
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex-col hidden md:flex no-print overflow-y-auto">
            <nav class="p-4 space-y-1 flex-1">
                <button onclick="switchTab('home')" id="nav-home" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition active bg-indigo-50 text-indigo-700">
                    <i class="fas fa-home w-5 text-center"></i> หน้าแรก
                </button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-sliders-h w-5 text-center"></i> ตั้งค่าพื้นฐาน
                </button>
                <button onclick="switchTab('students')" id="nav-students" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-users w-5 text-center"></i> รายชื่อนักเรียน
                </button>
                <button onclick="switchTab('competency')" id="nav-competency" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-bullseye w-5 text-center"></i> กำหนดสมรรถนะ
                </button>
                <button onclick="switchTab('assess')" id="nav-assess" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-user-edit w-5 text-center"></i> บันทึกผลประเมิน
                </button>
                <button onclick="switchTab('report')" id="nav-report" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-print w-5 text-center"></i> พิมพ์รายงาน
                </button>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <div class="bg-green-50 p-3 rounded-lg border border-green-100 text-[10px] text-green-800 leading-relaxed">
                    <i class="fas fa-check-circle mr-1"></i> <b>สถานะระบบ:</b> ระบบจะบันทึกข้อมูลลง Google Sheets โดยอัตโนมัติเมื่อมีการแก้ไขข้อมูล (จำเป็นต้องใส่ URL ในโค้ด)
                </div>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 overflow-hidden bg-slate-50/50 p-4 md:p-6 relative">

            <!-- View 0: Home (Dashboard) -->
            <div id="view-home" class="h-full overflow-y-auto fade-in">
                <div class="max-w-6xl mx-auto space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-bold uppercase">จำนวนนักเรียน</p>
                                <h3 class="text-2xl font-bold text-slate-800" id="dash-total-students">0</h3>
                                <p class="text-[10px] text-slate-400">คน</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-bold uppercase">เวลาเรียนเฉลี่ย</p>
                                <h3 class="text-2xl font-bold text-slate-800" id="dash-avg-attendance">0%</h3>
                                <p class="text-[10px] text-slate-400">จากทั้งหมด</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl">
                                <i class="fas fa-running"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-bold uppercase">กิจกรรมพัฒนาฯ</p>
                                <h3 class="text-2xl font-bold text-slate-800" id="dash-act-pass">0%</h3>
                                <p class="text-[10px] text-slate-400">ผ่านเกณฑ์</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xl">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-bold uppercase">คุณลักษณะฯ</p>
                                <h3 class="text-2xl font-bold text-slate-800" id="dash-char-pass">0%</h3>
                                <p class="text-[10px] text-slate-400">ผ่านเกณฑ์</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Bar Chart -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">สรุปผลประเมินรายสมรรถนะ (จำนวนนักเรียนต่อระดับ)</h3>
                            <div class="h-64">
                                <canvas id="competencyChart"></canvas>
                            </div>
                        </div>
                        <!-- Doughnut Chart -->
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-4">ภาพรวมระดับคุณภาพทั้งห้อง</h3>
                            <div class="h-64 flex justify-center">
                                <canvas id="levelChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 1: Settings -->
            <div id="view-settings" class="hidden h-full overflow-y-auto fade-in">
                <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm"><i class="fas fa-school"></i></span>
                        ข้อมูลปีการศึกษาและโรงเรียน
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ปีการศึกษา</label>
                            <input type="number" id="set-year" class="input-base" oninput="autoSaveSettings()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ระดับชั้น</label>
                            <input type="text" id="set-class" class="input-base" oninput="autoSaveSettings()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">จำนวนวันเรียนทั้งหมด (วัน)</label>
                            <input type="number" id="set-total-days" class="input-base" placeholder="เช่น 200" oninput="autoSaveSettings()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">วันที่ออกรายงาน</label>
                            <input type="date" id="set-date" class="input-base" oninput="autoSaveSettings()">
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ชื่อครูประจำชั้น (คนที่ 1)</label>
                            <div class="relative">
                                <i class="fas fa-user absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="set-teacher-1" class="input-base pl-8" placeholder="เช่น นายใจดี มีวินัย" oninput="autoSaveSettings()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ชื่อครูประจำชั้น (คนที่ 2)</label>
                            <div class="relative">
                                <i class="fas fa-user-plus absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="set-teacher-2" class="input-base pl-8" placeholder="(ถ้ามี)" oninput="autoSaveSettings()">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ชื่อผู้อำนวยการสถานศึกษา</label>
                            <div class="relative">
                                <i class="fas fa-user-tie absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="set-director" class="input-base pl-8" placeholder="เช่น นายวิสัยทัศน์ กว้างไกล" oninput="autoSaveSettings()">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1">ชื่อโรงเรียน</label>
                            <div class="relative">
                                <i class="fas fa-building absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="set-school" class="input-base pl-8" value="โรงเรียนหนองสำโรงวิทยา" oninput="autoSaveSettings()">
                            </div>
                        </div>
                        
                        <!-- Logo -->
                        <div class="md:col-span-2 mt-2 pt-4 border-t border-slate-100">
                            <label class="block text-xs font-bold text-slate-500 mb-2">ตราสัญลักษณ์โรงเรียน (Logo)</label>
                            <div class="flex items-center gap-4">
                                <div id="logo-preview" class="w-16 h-16 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center bg-slate-50 overflow-hidden">
                                    <i class="fas fa-image text-slate-300"></i>
                                </div>
                                <div>
                                    <input type="file" id="logo-upload" accept="image/*" class="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                                    <button onclick="removeLogo()" class="ml-2 text-xs text-red-500 hover:text-red-700 font-semibold"><i class="fas fa-trash"></i> ลบรูป</button>
                                    <p class="text-[10px] text-slate-400 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i> รองรับไฟล์รูปภาพทุกประเภท (ระบบจะย่อขนาดให้อัตโนมัติ)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 2: Students List -->
            <div id="view-students" class="hidden h-full flex flex-col fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm"><i class="fas fa-users"></i></span>
                                รายชื่อนักเรียน (Student List)
                            </h2>
                            <p class="text-xs text-slate-500 mt-1 ml-10">จัดการข้อมูลนักเรียนหรือนำเข้าจาก Excel</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                             <button onclick="addStudent()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-sm border border-blue-700 flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> เพิ่มนักเรียน
                            </button>
                             <button onclick="downloadTemplate()" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-200 transition border border-slate-300">
                                <i class="fas fa-file-excel text-green-600"></i> โหลดแบบฟอร์ม
                            </button>
                            <!-- Grade 51 Import -->
                            <div class="relative">
                                <input type="file" id="import-51" accept=".xlsx, .xls" class="hidden" onchange="importFrom51(event)">
                                <button onclick="document.getElementById('import-51').click()" class="bg-orange-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-orange-700 transition shadow-sm">
                                    <i class="fas fa-file-invoice"></i> นำเข้าเกรด 51 (แปลงผล)
                                </button>
                            </div>
                            <!-- Existing Import -->
                            <div class="relative">
                                <input type="file" id="excel-import" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
                                <button onclick="document.getElementById('excel-import').click()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition shadow-sm">
                                    <i class="fas fa-file-import"></i> นำเข้า Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto p-0">
                        <table class="w-full">
                            <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                                <tr class="text-xs font-bold text-slate-500 uppercase text-left border-b border-slate-200 bg-slate-50">
                                    <th class="p-3 w-16 text-center">เลขที่</th>
                                    <th class="p-3 w-32">รหัสนักเรียน</th>
                                    <th class="p-3 w-24">คำนำหน้า</th>
                                    <th class="p-3">ชื่อ</th>
                                    <th class="p-3">นามสกุล</th>
                                    <th class="p-3 w-20 text-center">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-slate-100 text-sm text-slate-700">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                        <span class="text-xs text-slate-400">จำนวนนักเรียนทั้งหมด: <span id="student-count" class="font-bold text-slate-600">0</span> คน</span>
                    </div>
                </div>
            </div>

            <!-- View 3: Competency Config -->
            <div id="view-competency" class="hidden h-full overflow-y-auto fade-in">
                <div class="max-w-6xl mx-auto space-y-6">
                    <!-- Criteria Reference Table -->
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 shadow-sm">
                        <h3 class="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle"></i> ตารางเปรียบเทียบเกณฑ์การตัดสิน (หลักสูตร 51 vs ปัจจุบัน)
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left bg-white rounded-lg overflow-hidden">
                                <thead class="bg-blue-100 text-blue-900">
                                    <tr>
                                        <th class="p-2 text-center w-16 border-r border-blue-200">ระดับ</th>
                                        <th class="p-2 border-r border-blue-200">เกรดเฉลี่ย (หลักสูตร 51)</th>
                                        <th class="p-2 border-r border-blue-200">ความหมาย (สมรรถนะ)</th>
                                        <th class="p-2 text-center">สัญลักษณ์สี</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-50 text-slate-700">
                                    <tr>
                                        <td class="p-2 text-center font-bold">4</td>
                                        <td class="p-2">3.5 - 4.0</td>
                                        <td class="p-2 font-bold text-indigo-700">เชี่ยวชาญ (Distinguished)</td>
                                        <td class="p-2 text-center"><div class="w-full h-4 bg-emerald-100 border border-emerald-300 rounded text-[10px] flex items-center justify-center text-emerald-700">สีเขียว</div></td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 text-center font-bold">3</td>
                                        <td class="p-2">2.5 - 3.49</td>
                                        <td class="p-2 font-bold text-blue-700">ชำนาญ (Proficient)</td>
                                        <td class="p-2 text-center"><div class="w-full h-4 bg-blue-100 border border-blue-300 rounded text-[10px] flex items-center justify-center text-blue-700">สีฟ้า</div></td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 text-center font-bold">2</td>
                                        <td class="p-2">1.5 - 2.49</td>
                                        <td class="p-2 font-bold text-orange-600">พัฒนา (Developing)</td>
                                        <td class="p-2 text-center"><div class="w-full h-4 bg-orange-100 border border-orange-300 rounded text-[10px] flex items-center justify-center text-orange-700">สีส้ม</div></td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 text-center font-bold">1</td>
                                        <td class="p-2">0 - 1.49</td>
                                        <td class="p-2 font-bold text-red-600">เริ่มต้น (Beginning)</td>
                                        <td class="p-2 text-center"><div class="w-full h-4 bg-red-100 border border-red-300 rounded text-[10px] flex items-center justify-center text-red-700">สีแดง</div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <span class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-sm"><i class="fas fa-list-ol"></i></span>
                                กำหนดสมรรถนะ (Competencies)
                            </h2>
                            <button onclick="addCompetency()" class="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-orange-600 transition shadow-sm">
                                <i class="fas fa-plus-circle"></i> เพิ่มสมรรถนะ
                            </button>
                        </div>
                        
                        <div class="overflow-hidden rounded-lg border border-slate-200">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-slate-50 text-xs font-bold text-slate-500 uppercase text-left border-b border-slate-200">
                                        <th class="p-3 w-16 text-center">ข้อที่</th>
                                        <th class="p-3">รายการความสามารถ</th>
                                        <th class="p-3 w-48 text-center bg-orange-50/50">คะแนนเป้าหมาย (Target)</th>
                                        <th class="p-3 w-16 text-center">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody id="competency-list" class="divide-y divide-slate-100 text-sm">
                                    <!-- JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View 4: Assessment -->
            <div id="view-assess" class="hidden h-full flex flex-col fade-in">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex space-x-1 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                        <button onclick="switchAssessSubTab('competency')" id="subtab-competency" class="px-4 py-1.5 text-xs font-bold rounded-md transition-colors bg-indigo-50 text-indigo-700">
                            <i class="fas fa-chart-bar mr-1"></i> ประเมินสมรรถนะ
                        </button>
                        <button onclick="switchAssessSubTab('general')" id="subtab-general" class="px-4 py-1.5 text-xs font-bold rounded-md transition-colors text-slate-500 hover:bg-slate-50">
                            <i class="fas fa-tasks mr-1"></i> ข้อมูลทั่วไป
                        </button>
                        <button onclick="switchAssessSubTab('comment')" id="subtab-comment" class="px-4 py-1.5 text-xs font-bold rounded-md transition-colors text-slate-500 hover:bg-slate-50">
                            <i class="fas fa-comment-dots mr-1"></i> คำอธิบาย
                        </button>
                    </div>
                </div>

                <!-- Tables Container -->
                <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                    
                    <!-- 3.1 Competency Table -->
                    <div id="assess-competency-view" class="flex-1 overflow-auto">
                        <table class="w-full border-collapse min-w-[1000px]">
                            <thead class="sticky top-0 bg-slate-50 shadow-sm z-20">
                                <tr id="competency-header-row" class="text-xs font-bold text-slate-500 uppercase tracking-wider text-left h-12">
                                    <!-- JS -->
                                </tr>
                            </thead>
                            <tbody id="competency-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 3.2 General Table -->
                    <div id="assess-general-view" class="hidden flex-1 overflow-auto">
                        <table class="w-full border-collapse min-w-[800px]">
                            <thead class="sticky top-0 bg-slate-50 shadow-sm z-20">
                                <tr class="text-xs font-bold text-slate-500 uppercase tracking-wider text-left h-12">
                                    <th class="p-3 border-b border-r w-16 text-center sticky left-0 bg-slate-50 z-10">ที่</th>
                                    <th class="p-3 border-b border-r min-w-[200px] sticky left-16 bg-slate-50 z-10">ชื่อ-สกุล</th>
                                    <th class="p-3 border-b w-40 text-center bg-blue-50/30">มาเรียน (วัน) / %</th>
                                    <th class="p-3 border-b w-40 text-center border-l">กิจกรรมพัฒนาฯ</th>
                                    <th class="p-3 border-b w-40 text-center">คุณลักษณะฯ</th>
                                    <th class="p-3 border-b min-w-[200px]">หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody id="general-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 3.3 Comments View -->
                    <div id="assess-comment-view" class="hidden flex-1 flex flex-col overflow-hidden">
                        <div class="flex items-center gap-4 p-4 border-b border-slate-100 flex-shrink-0">
                            <label class="text-sm font-bold text-slate-700">เลือกนักเรียน:</label>
                            <select id="assess-student-select" onchange="renderCommentForm()" class="input-base max-w-sm"></select>
                        </div>
                        <div id="comment-form-container" class="flex-1 overflow-y-auto hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 w-1/3 border-b">สมรรถนะ</th>
                                        <th class="px-4 py-3 w-32 text-center border-b">ระดับ</th>
                                        <th class="px-4 py-3 border-b">คำอธิบายพฤติกรรม (Auto-fill)</th>
                                    </tr>
                                </thead>
                                <tbody id="comment-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div id="comment-empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                            <i class="fas fa-mouse-pointer text-4xl mb-3 opacity-30"></i>
                            <p>กรุณาเลือกรายชื่อนักเรียนด้านบน</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- View 5: Report -->
            <div id="view-report" class="hidden h-full overflow-y-auto fade-in">
                <div class="max-w-5xl mx-auto mb-6 flex items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm no-print sticky top-0 z-30">
                    <div class="flex items-center gap-4 w-full">
                        <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center"><i class="fas fa-print"></i></div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">เลือกนักเรียนที่จะพิมพ์</label>
                            <select id="report-student-select" onchange="renderReportCard()" class="input-base w-full md:w-1/2"></select>
                        </div>
                    </div>
                    <button onclick="window.print()" class="bg-slate-800 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-slate-900 transition flex items-center gap-2 shadow-lg shadow-slate-200">
                        <i class="fas fa-print"></i> พิมพ์ / PDF
                    </button>
                </div>
                
                <div class="flex justify-center pb-20 overflow-x-auto bg-slate-200/50 p-8 rounded-xl">
                    <div id="report-area" class="a4-page mx-auto"></div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- Data & Config ---
        
        // ==========================================
        // [[ ส่วนตั้งค่าการเชื่อมต่อ Google Sheets ]]
        // นำ Web App URL มาวางในเครื่องหมายคำพูดด้านล่างนี้ (จำเป็นต้องใส่เพื่อให้ระบบบันทึกอัตโนมัติทำงาน)
        // ตัวอย่าง: const CONFIG_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx.../exec";
        const CONFIG_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz6eG2vupOOxYQhWSxJxf3al1w7XTqOhJCXdxtIKYp5Q1HR40owfwkGqpGTGLURkXmI/exec"; 
        // ==========================================

        const competencyDefaults = [
            "เข้าใจความหมายของคำ ข้อความ ภาพ สัญลักษณ์ และสรุปสาระสำคัญเพื่อสื่อสารได้",
            "เขียนประโยคง่ายๆ เพื่อถ่ายทอดความคิดและความรู้สึก",
            "ใช้แนวคิดพื้นฐานทางคณิตศาสตร์แก้ปัญหาในชีวิตประจำวัน",
            "เข้าใจปรากฏการณ์ทางธรรมชาติ สิ่งแวดล้อม และใช้เทคโนโลยี",
            "ปฏิบัติตนเป็นสมาชิกที่ดีของครอบครัวและโรงเรียน",
            "รู้ที่มาของรายรับ-รายจ่าย และใช้จ่ายอย่างพอเพียง",
            "ดูแลสุขภาพ ควบคุมอารมณ์ และขอความช่วยเหลือเมื่อเกิดเหตุร้าย",
            "ปฏิบัติกิจกรรมทางศิลปะและวัฒนธรรมท้องถิ่นด้วยความกระตือรือร้น"
        ];
        // Updated levels to show comparison (51 vs 68)
        const levels = { 
            1: "เริ่มต้น (ระดับ 1)", 
            2: "พัฒนา (ระดับ 2)", 
            3: "ชำนาญ (ระดับ 3)", 
            4: "เชี่ยวชาญ (ระดับ 4)" 
        };
        const commentPresets = {
            1: ["ยังต้องได้รับการดูแลอย่างใกล้ชิด", "เริ่มเข้าใจพื้นฐานแต่ยังต้องฝึกฝน", "ทำได้เมื่อได้รับคำแนะนำ", "มีความพยายามแต่ยังไม่คล่อง"],
            2: ["มีพัฒนาการที่ดีขึ้นตามลำดับ", "ทำได้ด้วยตนเองในบางครั้ง", "เข้าใจหลักการพื้นฐาน", "มีความตั้งใจในการฝึกฝน"],
            3: ["ทำได้ดีและถูกต้องตามหลักเกณฑ์", "มีความชำนาญในการปฏิบัติ", "สื่อสารให้ผู้อื่นเข้าใจได้ดี", "ทำงานได้รวดเร็วถูกต้อง"],
            4: ["ทำได้ดีเยี่ยม เป็นแบบอย่างได้", "มีความคิดสร้างสรรค์ดีมาก", "ถ่ายทอดความรู้ให้เพื่อนได้", "มีความเป็นผู้นำ"]
        };

        // Initialize with Defaults (No LocalStorage Load)
        let appData = {
            settings: { 
                year: "2568", 
                class: "ประถมศึกษาปีที่ 1", 
                teacher1: "", 
                teacher2: "", 
                director: "", 
                date: new Date().toISOString().split('T')[0], 
                school: "โรงเรียนหนองสำโรงวิทยา", 
                logo: null, 
                totalDays: 200 
            },
            competencies: competencyDefaults.map(c => ({ title: c, target: 2 })),
            students: [{ 
                id: 1, number: 1, studentId: "68001", prefix: "ด.ช.", firstname: "ตัวอย่าง", lastname: "ตั้งใจเรียน", 
                name: "ด.ช.ตัวอย่าง ตั้งใจเรียน", attendance: "100", daysAttended: 200, scores: [2,3,3,2,3,4,3,3], actPass: true, charPass: true, comments: [], remarks: "" 
            }]
        };

        // --- Charts Variables ---
        let competencyChart = null;
        let levelChart = null;
        
        // --- Cloud Save Variables ---
        let cloudSaveTimer = null;
        const CLOUD_SAVE_DELAY = 5000; // 5 วินาที

        // --- Core Functions ---
        function init() {
            // No loadData() called here
            renderSettings();
            renderCompetencyConfig();
            renderAllAssessTables();
            renderStudentList();
            updateStudentSelect();
            updateCommentStudentSelect();
            renderDashboard(); 
            document.getElementById('logo-upload').addEventListener('change', handleLogoUpload);
            
            updateCloudStatusUI();
            
            // เพิ่มบรรทัดนี้: เรียกฟังก์ชันโหลดข้อมูลจาก Cloud ทันทีเมื่อเปิดเว็บ
            if (CONFIG_WEB_APP_URL) {
                loadFromCloud();
            }
        }

        // --- เพิ่มฟังก์ชันใหม่สำหรับดึงข้อมูล ---
        async function loadFromCloud() {
            const url = CONFIG_WEB_APP_URL;
            if (!url) return;

            updateCloudStatusUI('pending'); // ใช้สถานะ pending เพื่อหมุนติ้วๆ บอกว่ากำลังโหลด
            document.getElementById('cloud-status-text').innerText = "กำลังโหลด...";

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'error') {
                    throw new Error(data.error);
                }

                // ถ้ามีข้อมูล Settings กลับมา ให้อัปเดต
                if (data.settings && Object.keys(data.settings).length > 0) {
                    // ผสานค่าเดิมกับค่าใหม่ (เพื่อเก็บ Logo ไว้ถ้าไม่ได้ส่งมา)
                    appData.settings = { ...appData.settings, ...data.settings };
                    // แปลงค่าตัวเลขกลับ
                    if(appData.settings.totalDays) appData.settings.totalDays = parseInt(appData.settings.totalDays);
                }

                // ถ้ามี Competencies กลับมา
                if (data.competencies && data.competencies.length > 0) {
                    appData.competencies = data.competencies;
                }

                // ถ้ามี Students กลับมา
                if (data.students && data.students.length > 0) {
                    appData.students = data.students;
                }

                // รีเฟรชหน้าจอทั้งหมดด้วยข้อมูลใหม่
                renderSettings();
                renderCompetencyConfig();
                renderAllAssessTables();
                renderStudentList();
                updateStudentSelect();
                updateCommentStudentSelect();
                renderDashboard();

                updateCloudStatusUI('saved'); // เปลี่ยนสถานะเป็นพร้อมใช้งาน
                // alert("โหลดข้อมูลล่าสุดจาก Google Sheets เรียบร้อยแล้ว"); // จะเปิดก็ได้ถ้าอยากให้แจ้งเตือน

            } catch (error) {
                console.error("Error loading data:", error);
                updateCloudStatusUI('error');
                // ไม่ต้อง alert กวนใจถ้าเป็นครั้งแรก (Sheet ยังว่าง)
                if(error.toString().indexOf("Sheet not found") === -1) {
                     alert("ไม่สามารถดึงข้อมูลล่าสุดได้: " + error.message);
                } else {
                     updateCloudStatusUI('idle'); // กลับสู่สถานะปกติถ้ายังไม่มีข้อมูล
                }
            }
        }

        // --- Auto-Save System (In-Memory & Cloud Only) ---
        function autoSave() {
            // 1. In-Memory: data variable `appData` is already updated by the input events.
            // 2. No Local Storage saving.
            // 3. Trigger Cloud Auto-Save (Debounced)
            triggerCloudAutoSave();

            // Optional: Re-render dashboard if visible
            if(!document.getElementById('view-home').classList.contains('hidden')) {
                renderDashboard();
            }
        }

        // --- Cloud Auto-Save Logic ---
        function triggerCloudAutoSave() {
            const url = CONFIG_WEB_APP_URL;
            if (!url) return; 

            updateCloudStatusUI('pending');

            if (cloudSaveTimer) clearTimeout(cloudSaveTimer);

            cloudSaveTimer = setTimeout(() => {
                saveToCloud(true); // true = silent mode
            }, CLOUD_SAVE_DELAY);
        }

        function updateCloudStatusUI(state = 'idle') {
            const url = CONFIG_WEB_APP_URL;
            const el = document.getElementById('cloud-status');
            const textEl = document.getElementById('cloud-status-text');
            const iconEl = el.querySelector('i');
            const btnConnect = document.getElementById('btn-cloud-connect');

            if (!url) {
                el.classList.add('hidden');
                btnConnect.classList.remove('bg-green-100', 'text-green-800');
                btnConnect.classList.add('bg-white', 'text-green-700');
                btnConnect.innerHTML = '<i class="fas fa-exclamation-circle text-sm text-red-500"></i> ยังไม่ตั้งค่า Cloud';
                btnConnect.title = "กรุณาใส่ Web App URL ในโค้ด";
                return;
            }

            el.classList.remove('hidden');
            btnConnect.classList.remove('bg-white', 'text-green-700');
            btnConnect.classList.add('bg-green-100', 'text-green-800');
            btnConnect.innerHTML = '<i class="fas fa-check-circle text-sm"></i> ระบบ Cloud พร้อมใช้งาน';
            btnConnect.title = "ระบบพร้อมบันทึกอัตโนมัติ";

            if (state === 'pending') {
                el.className = "text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-600";
                iconEl.className = "fas fa-circle-notch fa-spin";
                textEl.innerText = "กำลังรอ...";
            } else if (state === 'saving') {
                el.className = "text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-100 text-blue-600";
                iconEl.className = "fas fa-spinner fa-spin";
                textEl.innerText = "กำลังส่ง...";
            } else if (state === 'saved') {
                el.className = "text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-600";
                iconEl.className = "fas fa-check";
                textEl.innerText = "บันทึกแล้ว";
            } else if (state === 'error') {
                el.className = "text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-600";
                iconEl.className = "fas fa-exclamation-triangle";
                textEl.innerText = "ผิดพลาด";
            } else {
                el.className = "text-[10px] font-bold transition-colors duration-300 flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 text-slate-400";
                iconEl.className = "fas fa-cloud";
                textEl.innerText = "พร้อมใช้งาน";
            }
        }

        function autoSaveSettings() {
            appData.settings.year = document.getElementById('set-year').value;
            appData.settings.class = document.getElementById('set-class').value;
            appData.settings.teacher1 = document.getElementById('set-teacher-1').value;
            appData.settings.teacher2 = document.getElementById('set-teacher-2').value;
            appData.settings.director = document.getElementById('set-director').value;
            appData.settings.date = document.getElementById('set-date').value;
            appData.settings.school = document.getElementById('set-school').value;
            appData.settings.totalDays = parseInt(document.getElementById('set-total-days').value) || 200;
            
            appData.students.forEach((s, idx) => {
                updateDaysAttended(idx, s.daysAttended, false);
            });
            if(!document.getElementById('assess-general-view').classList.contains('hidden')) {
                renderGeneralTable();
            }
            autoSave();
        }

        // --- Tab Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'text-indigo-700');
                el.classList.add('text-slate-600');
                el.classList.remove('active'); 
            });
            const btn = document.getElementById('nav-' + tabId);
            if(btn) {
                btn.classList.remove('text-slate-600');
                btn.classList.add('bg-indigo-50', 'text-indigo-700', 'active');
            }
            ['home', 'settings', 'students', 'competency', 'assess', 'report'].forEach(id => {
                const el = document.getElementById('view-' + id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            if(tabId === 'report') updateStudentSelect();
            if(tabId === 'students') renderStudentList();
            if(tabId === 'home') renderDashboard(); 
        }

        function switchAssessSubTab(subTab) {
            document.querySelectorAll('#view-assess button[id^="subtab-"]').forEach(el => {
                el.className = "px-4 py-1.5 text-xs font-bold rounded-md transition-colors text-slate-500 hover:bg-slate-50";
            });
            const btn = document.getElementById('subtab-' + subTab);
            btn.className = "px-4 py-1.5 text-xs font-bold rounded-md transition-colors bg-indigo-50 text-indigo-700 border border-indigo-100";
            
            ['competency', 'general', 'comment'].forEach(id => document.getElementById('assess-' + id + '-view').classList.add('hidden'));
            document.getElementById('assess-' + subTab + '-view').classList.remove('hidden');
            
            if(subTab === 'competency') renderCompetencyTable();
            if(subTab === 'general') renderGeneralTable();
            if(subTab === 'comment') updateCommentStudentSelect();
        }

        // --- Dashboard Logic ---
        function renderDashboard() {
            const totalStudents = appData.students.length;
            if(totalStudents === 0) return;

            const totalAtt = appData.students.reduce((sum, s) => sum + (parseInt(s.attendance) || 0), 0);
            const avgAtt = Math.round(totalAtt / totalStudents);

            const actPass = appData.students.filter(s => s.actPass).length;
            const charPass = appData.students.filter(s => s.charPass).length;
            const actPct = Math.round((actPass / totalStudents) * 100);
            const charPct = Math.round((charPass / totalStudents) * 100);

            document.getElementById('dash-total-students').innerText = totalStudents;
            document.getElementById('dash-avg-attendance').innerText = avgAtt + "%";
            document.getElementById('dash-act-pass').innerText = actPct + "%";
            document.getElementById('dash-char-pass').innerText = charPct + "%";

            // Chart Data Preparation
            const levelCountsPerComp = {
                1: new Array(appData.competencies.length).fill(0),
                2: new Array(appData.competencies.length).fill(0),
                3: new Array(appData.competencies.length).fill(0),
                4: new Array(appData.competencies.length).fill(0)
            };

            appData.students.forEach(s => {
                s.scores.forEach((score, compIdx) => {
                    const validScore = (score >= 1 && score <= 4) ? score : 1;
                    levelCountsPerComp[validScore][compIdx]++;
                });
            });

            const overallStudentLevels = [0, 0, 0, 0]; 
            appData.students.forEach(s => {
                const sum = s.scores.reduce((a, b) => a + (b || 1), 0);
                const avg = Math.round(sum / s.scores.length); 
                const levelIndex = Math.max(0, Math.min(3, avg - 1)); 
                overallStudentLevels[levelIndex]++;
            });

            renderCharts(levelCountsPerComp, overallStudentLevels);
        }

        function renderCharts(levelCountsPerComp, overallStudentLevels) {
            const ctx1 = document.getElementById('competencyChart').getContext('2d');
            if (competencyChart) competencyChart.destroy();
            
            competencyChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: appData.competencies.map((_, i) => `ข้อที่ ${i+1}`),
                    datasets: [
                        { label: 'เริ่มต้น', data: levelCountsPerComp[1], backgroundColor: '#ef4444' }, 
                        { label: 'พัฒนา', data: levelCountsPerComp[2], backgroundColor: '#f97316' }, 
                        { label: 'ชำนาญ', data: levelCountsPerComp[3], backgroundColor: '#3b82f6' }, 
                        { label: 'เชี่ยวชาญ', data: levelCountsPerComp[4], backgroundColor: '#10b981' } 
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + ' คน';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'จำนวนนักเรียน (คน)' }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('levelChart').getContext('2d');
            if (levelChart) levelChart.destroy();
            
            levelChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['เริ่มต้น', 'พัฒนา', 'ชำนาญ', 'เชี่ยวชาญ'],
                    datasets: [{
                        data: overallStudentLevels,
                        backgroundColor: ['#ef4444', '#f97316', '#3b82f6', '#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = Math.round((context.raw / total) * 100) + '%';
                                    return context.label + ': ' + context.raw + ' คน (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Student List View Logic ---
        function renderStudentList() {
            const tbody = document.getElementById('student-list-body');
            tbody.innerHTML = '';
            document.getElementById('student-count').innerText = appData.students.length;

            appData.students.sort((a,b) => (a.number || 999) - (b.number || 999));

            appData.students.forEach((s, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 group";
                
                const prefix = s.prefix || "";
                const first = s.firstname || (s.name ? s.name.replace(prefix, '').trim().split(' ')[0] : "");
                const last = s.lastname || (s.name ? s.name.replace(prefix, '').replace(first, '').trim() : "");

                tr.innerHTML = `
                    <td class="p-2 text-center">
                        <input type="number" value="${s.number || ''}" onchange="updateStudentDetail(${idx}, 'number', this.value)" class="input-base text-center h-9" placeholder="-">
                    </td>
                    <td class="p-2">
                        <input type="text" value="${s.studentId || ''}" onchange="updateStudentDetail(${idx}, 'studentId', this.value)" class="input-base h-9" placeholder="รหัส">
                    </td>
                    <td class="p-2">
                        <input type="text" value="${prefix}" onchange="updateStudentDetail(${idx}, 'prefix', this.value)" class="input-base h-9" placeholder="คำนำหน้า">
                    </td>
                    <td class="p-2">
                        <input type="text" value="${first}" onchange="updateStudentDetail(${idx}, 'firstname', this.value)" class="input-base h-9 font-medium text-slate-700" placeholder="ชื่อ">
                    </td>
                    <td class="p-2">
                        <input type="text" value="${last}" onchange="updateStudentDetail(${idx}, 'lastname', this.value)" class="input-base h-9 text-slate-700" placeholder="นามสกุล">
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="removeStudent(${idx})" class="text-red-300 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStudentDetail(idx, field, value) {
            const s = appData.students[idx];
            s[field] = value;
            
            if (['prefix', 'firstname', 'lastname'].includes(field)) {
                const p = s.prefix || '';
                const f = s.firstname || '';
                const l = s.lastname || '';
                s.name = `${p}${f} ${l}`.trim();
            }
            
            autoSave();
        }

        function downloadTemplate() {
            const ws = XLSX.utils.json_to_sheet([
                { "เลขที่": 1, "เลขประจำตัว": "1001", "คำนำหน้า": "ด.ช.", "ชื่อ": "สมชาย", "นามสกุล": "เรียนดี" },
                { "เลขที่": 2, "เลขประจำตัว": "1002", "คำนำหน้า": "ด.ญ.", "ชื่อ": "สมหญิง", "นามสกุล": "ขยันหมั่นเพียร" }
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "รายชื่อนักเรียน");
            XLSX.writeFile(wb, "Student_Template.xlsx");
        }

        // --- NEW: Curriculum 51 Grade Import Logic ---
        function importFrom51(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                if(jsonData.length > 0) {
                    if(confirm(`พบข้อมูล ${jsonData.length} รายการ ต้องการนำเข้าเกรดหลักสูตร 51 หรือไม่? \nระบบจะแปลงเป็นเกรด 1-4 ให้โดยอัตโนมัติ`)) {
                        processImportedData51(jsonData);
                    }
                } else {
                    alert('ไม่พบข้อมูลในไฟล์');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = ''; 
        }

        function processImportedData51(data) {
            const total = parseInt(appData.settings.totalDays) || 200;
            const existingScores = {};
            appData.students.forEach(s => {
                const key = s.studentId || s.number; 
                if(key) existingScores[key] = { comments: s.comments, remarks: s.remarks, attendance: s.attendance, daysAttended: s.daysAttended };
            });

            const newStudents = data.map(row => {
                const number = row['เลขที่'] || row['Number'] || 0;
                const sid = row['เลขประจำตัว'] || row['ID'] ? String(row['เลขประจำตัว'] || row['ID']) : "";
                
                let fullName = "";
                if(row['ชื่อ - สกุล']) fullName = row['ชื่อ - สกุล'];
                else if(row['ชื่อ-สกุล']) fullName = row['ชื่อ-สกุล'];
                else if (row['ชื่อ'] && row['นามสกุล']) fullName = `${row['คำนำหน้า']||''}${row['ชื่อ']} ${row['นามสกุล']}`.trim();
                else {
                      const nameKey = Object.keys(row).find(k => k.includes('ชื่อ'));
                      if(nameKey) fullName = row[nameKey];
                }

                const getGrade = (keywords) => {
                    const key = Object.keys(row).find(k => keywords.every(kw => k.includes(kw)));
                    const val = parseFloat(row[key]);
                    return isNaN(val) ? 0 : val;
                };

                const thai = getGrade(['ภาษาไทย']);
                const eng = getGrade(['ภาษาอังกฤษ']);
                const math = getGrade(['คณิตศาสตร์']);
                const sci = getGrade(['วิทยาศาสตร์']);
                const tech = getGrade(['เทคโนโลยี']);
                const soc = getGrade(['สังคม']);
                const econ = getGrade(['เศรษฐกิจ']);
                const health = getGrade(['สุขภาพ']);
                const art = getGrade(['ศิลปะ']);

                const scores = [];

                const c1_2_val = (thai * 0.7) + (eng * 0.3);
                const c1_2_grade = convertGrade51To68(c1_2_val);
                scores[0] = c1_2_grade; 
                scores[1] = c1_2_grade; 

                scores[2] = convertGrade51To68(math);

                const c4_val = (sci * 0.8) + (tech * 0.2);
                scores[3] = convertGrade51To68(c4_val);

                scores[4] = convertGrade51To68(soc);
                scores[5] = convertGrade51To68(econ);
                scores[6] = convertGrade51To68(health);
                scores[7] = convertGrade51To68(art);

                while(scores.length < appData.competencies.length) scores.push(2);

                const key = sid || number;
                const oldData = existingScores[key] || {};

                return {
                    id: Date.now() + Math.random(),
                    number: number,
                    studentId: sid,
                    prefix: "", 
                    firstname: "",
                    lastname: "",
                    name: fullName || "ไม่ระบุชื่อ",
                    attendance: oldData.attendance || "100",
                    daysAttended: oldData.daysAttended || total,
                    scores: scores,
                    actPass: true,
                    charPass: true,
                    comments: oldData.comments || [],
                    remarks: oldData.remarks || ""
                };
            });
            
            newStudents.sort((a,b) => a.number - b.number);
            
            appData.students = newStudents;
            renderStudentList();
            renderAllAssessTables();
            updateStudentSelect();
            updateCommentStudentSelect();
            autoSave();
            alert("นำเข้าและแปลงเกรดเรียบร้อยแล้ว");
        }

        function convertGrade51To68(grade) {
            if (grade >= 3.5) return 4;
            if (grade >= 2.5) return 3;
            if (grade >= 1.5) return 2;
            return 1;
        }

        // --- Existing Import ---
        function importFromExcel(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                if(jsonData.length > 0) {
                    if(confirm(`พบข้อมูล ${jsonData.length} รายการ ต้องการนำเข้าหรือไม่? \n(ข้อมูลเดิมจะถูกเขียนทับหากเลขที่ตรงกัน)`)) {
                        processImportedData(jsonData);
                    }
                } else {
                    alert('ไม่พบข้อมูลในไฟล์');
                }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = ''; 
        }

        function processImportedData(data) {
            const total = parseInt(appData.settings.totalDays) || 200;
            const existingScores = {};
            appData.students.forEach(s => {
                const key = s.studentId || s.number; 
                if(key) existingScores[key] = { scores: s.scores, comments: s.comments, remarks: s.remarks, attendance: s.attendance, daysAttended: s.daysAttended };
            });

            const newStudents = data.map(row => {
                const number = row['เลขที่'] || 0;
                const sid = row['เลขประจำตัว'] ? String(row['เลขประจำตัว']) : "";
                const prefix = row['คำนำหน้า'] || "";
                const first = row['ชื่อ'] || "";
                const last = row['นามสกุล'] || "";
                const fullName = `${prefix}${first} ${last}`.trim();
                
                const key = sid || number;
                const oldData = existingScores[key] || {};

                return {
                    id: Date.now() + Math.random(),
                    number: number,
                    studentId: sid,
                    prefix: prefix,
                    firstname: first,
                    lastname: last,
                    name: fullName,
                    attendance: oldData.attendance || "100",
                    daysAttended: oldData.daysAttended || total,
                    scores: oldData.scores || new Array(appData.competencies.length).fill(2),
                    actPass: true,
                    charPass: true,
                    comments: oldData.comments || [],
                    remarks: oldData.remarks || ""
                };
            });
            
            newStudents.sort((a,b) => a.number - b.number);
            
            appData.students = newStudents;
            renderStudentList();
            renderAllAssessTables();
            updateStudentSelect();
            updateCommentStudentSelect();
            autoSave();
            alert("นำเข้าข้อมูลเรียบร้อยแล้ว");
        }

        // --- Setting & Logo ---
        function renderSettings() {
            const s = appData.settings;
            document.getElementById('set-year').value = s.year;
            document.getElementById('set-class').value = s.class;
            document.getElementById('set-teacher-1').value = s.teacher1 || "";
            document.getElementById('set-teacher-2').value = s.teacher2 || "";
            document.getElementById('set-director').value = s.director;
            document.getElementById('set-date').value = s.date;
            document.getElementById('set-school').value = s.school;
            document.getElementById('set-total-days').value = s.totalDays || 200;
            renderLogoPreview();
        }
        
        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) { 
                alert("ไฟล์ต้นฉบับมีขนาดใหญ่เกินไป (ต้องไม่เกิน 10MB)");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxWidth = 400;
                    const maxHeight = 400;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    try {
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        appData.settings.logo = dataUrl;
                        renderLogoPreview();
                        autoSave();
                    } catch (err) {
                        console.error(err);
                        alert("เกิดข้อผิดพลาดในการประมวลผลรูปภาพ");
                    }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() { appData.settings.logo = null; document.getElementById('logo-upload').value = ""; renderLogoPreview(); autoSave(); }
        function renderLogoPreview() {
            const el = document.getElementById('logo-preview');
            el.innerHTML = appData.settings.logo ? `<img src="${appData.settings.logo}" class="w-full h-full object-contain">` : `<i class="fas fa-image text-slate-300"></i>`;
        }

        // --- Competencies ---
        function renderCompetencyConfig() {
            const tbody = document.getElementById('competency-list');
            tbody.innerHTML = '';
            appData.competencies.forEach((comp, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="p-3 text-center text-slate-400">${idx + 1}</td>
                    <td class="p-3"><input type="text" value="${comp.title}" oninput="updateCompTitle(${idx}, this.value)" class="w-full border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none bg-transparent py-1"></td>
                    <td class="p-3 text-center">
                        <select onchange="updateCompTarget(${idx}, this.value)" class="text-xs border-slate-200 rounded p-1 w-full bg-slate-50 border focus:ring-1 focus:ring-orange-300">
                            ${[1,2,3,4].map(v => `<option value="${v}" ${comp.target==v?'selected':''}>${v} - ${levels[v]}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-3 text-center"><button onclick="removeCompetency(${idx})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        function updateCompTitle(i, v) { appData.competencies[i].title = v; autoSave(); }
        function updateCompTarget(i, v) { appData.competencies[i].target = parseInt(v); autoSave(); }
        function addCompetency() { appData.competencies.push({title:"สมรรถนะใหม่", target:2}); appData.students.forEach(s => s.scores.push(2)); renderCompetencyConfig(); autoSave(); }
        function removeCompetency(i) { if(confirm("ลบสมรรถนะนี้?")) { appData.competencies.splice(i, 1); appData.students.forEach(s => s.scores.splice(i, 1)); renderCompetencyConfig(); autoSave(); } }

        // --- Assessment Rendering ---
        function renderAllAssessTables() {
            renderCompetencyTable();
            renderGeneralTable();
        }

        function renderCompetencyTable() {
            const hRow = document.getElementById('competency-header-row');
            let hHTML = `<th class="p-3 border-b border-r w-12 text-center bg-slate-50 sticky-col left-0 z-30">ที่</th><th class="p-3 border-b border-r min-w-[200px] bg-slate-50 sticky-col left-12 z-30 shadow-sm">ชื่อ-สกุล</th>`;
            appData.competencies.forEach((_, i) => hHTML += `<th class="p-3 border-b text-center min-w-[60px] text-[10px] text-slate-400">ข้อ ${i+1}</th>`);
            hHTML += `<th class="p-3 border-b w-12"></th>`;
            hRow.innerHTML = hHTML;

            const tbody = document.getElementById('competency-table-body');
            tbody.innerHTML = '';
            
            appData.students.sort((a,b) => (a.number || 999) - (b.number || 999));
            
            appData.students.forEach((std, sIdx) => {
                const tr = document.createElement('tr');
                tr.className = "table-row-hover group";
                let inputs = '';
                appData.competencies.forEach((_, cIdx) => {
                    const sc = std.scores[cIdx] || 1;
                    const colors = {1:'bg-red-50 text-red-600 border-red-200', 2:'bg-orange-50 text-orange-600 border-orange-200', 3:'bg-blue-50 text-blue-600 border-blue-200', 4:'bg-emerald-50 text-emerald-600 border-emerald-200'};
                    inputs += `<td class="p-2 text-center border-b border-slate-50"><select onchange="updateScore(${sIdx}, ${cIdx}, this.value)" class="w-10 text-center text-xs font-bold rounded border ${colors[sc]} appearance-none py-1 cursor-pointer focus:ring-2 ring-indigo-200 outline-none"><option value="1" ${sc==1?'selected':''}>1</option><option value="2" ${sc==2?'selected':''}>2</option><option value="3" ${sc==3?'selected':''}>3</option><option value="4" ${sc==4?'selected':''}>4</option></select></td>`;
                });
                tr.innerHTML = `<td class="p-3 border-b border-r text-center text-slate-400 sticky-col left-0 z-10">${std.number || sIdx+1}</td>
                <td class="p-3 border-b border-r sticky-col left-12 z-10"><input type="text" value="${std.name}" oninput="updateStudentField(${sIdx}, 'name', this.value)" class="w-full bg-transparent border-none p-1 focus:ring-0 font-medium text-slate-700"></td>
                ${inputs}
                <td class="p-3 border-b text-center"><button onclick="removeStudent(${sIdx})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        function renderGeneralTable() {
            const tbody = document.getElementById('general-table-body');
            tbody.innerHTML = '';
            const total = parseInt(appData.settings.totalDays) || 200;
            
            appData.students.sort((a,b) => (a.number || 999) - (b.number || 999));
            
            appData.students.forEach((std, sIdx) => {
                const tr = document.createElement('tr');
                tr.className = "table-row-hover";
                const passClass = (pass) => pass ? "bg-emerald-100 text-emerald-700 border-emerald-200" : "bg-red-100 text-red-700 border-red-200";
                
                const displayDays = std.daysAttended !== undefined ? std.daysAttended : Math.round((parseInt(std.attendance)/100)*total);
                
                tr.innerHTML = `
                    <td class="p-3 border-b border-r text-center text-slate-400 sticky-col left-0 bg-white z-10">${std.number || sIdx+1}</td>
                    <td class="p-3 border-b border-r sticky-col left-16 bg-white z-10 font-medium text-slate-700">
                        <input type="text" value="${std.name}" oninput="updateStudentField(${sIdx}, 'name', this.value)" class="w-full bg-transparent border-none p-1 focus:ring-0 font-medium text-slate-700 placeholder-slate-400" placeholder="ชื่อ-สกุล">
                    </td>
                    <td class="p-3 border-b text-center">
                        <div class="flex items-center justify-center gap-2">
                            <input type="number" value="${displayDays}" oninput="updateDaysAttended(${sIdx}, this.value)" class="w-16 text-center border rounded p-1 text-xs font-bold text-slate-700">
                            <span class="text-xs text-slate-400 w-10 text-left" id="att-pct-${sIdx}">${std.attendance}%</span>
                        </div>
                    </td>
                    <td class="p-3 border-b text-center border-l"><select onchange="updateStudentField(${sIdx}, 'actPass', this.value==='true')" class="text-xs font-bold rounded px-2 py-1 border ${passClass(std.actPass)}"><option value="true" ${std.actPass?'selected':''}>ผ่าน</option><option value="false" ${!std.actPass?'selected':''}>ไม่ผ่าน</option></select></td>
                    <td class="p-3 border-b text-center"><select onchange="updateStudentField(${sIdx}, 'charPass', this.value==='true')" class="text-xs font-bold rounded px-2 py-1 border ${passClass(std.charPass)}"><option value="true" ${std.charPass?'selected':''}>ผ่าน</option><option value="false" ${!std.charPass?'selected':''}>ไม่ผ่าน</option></select></td>
                    <td class="p-3 border-b"><input type="text" value="${std.remarks||''}" oninput="updateStudentField(${sIdx}, 'remarks', this.value)" class="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none text-xs" placeholder="..."></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Comments Logic ---
        function renderCommentForm() {
            const sIdx = document.getElementById('assess-student-select').value;
            const container = document.getElementById('comment-form-container');
            const empty = document.getElementById('comment-empty-state');
            const tbody = document.getElementById('comment-table-body');
            
            if(sIdx === "") { container.classList.add('hidden'); empty.classList.remove('hidden'); return; }
            container.classList.remove('hidden'); empty.classList.add('hidden');
            tbody.innerHTML = '';
            
            const std = appData.students[sIdx];
            appData.competencies.forEach((comp, cIdx) => {
                const sc = std.scores[cIdx] || 1;
                const existing = std.comments ? std.comments.find(c => c.item === cIdx) : null;
                let txt = existing ? existing.text : commentPresets[sc][0];
                if(!existing) updateComment(sIdx, cIdx, txt);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 align-top">
                        <span class="text-[10px] text-slate-400 block mb-1">ข้อ ${cIdx+1}</span>
                        <span class="font-medium text-slate-700">${comp.title}</span>
                    </td>
                    <td class="px-4 py-3 text-center align-top"><span class="inline-block px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600">${levels[sc]}</span></td>
                    <td class="px-4 py-3">
                        <textarea id="cmt-${sIdx}-${cIdx}" oninput="updateComment(${sIdx}, ${cIdx}, this.value)" class="w-full border rounded-lg p-2 text-sm focus:ring-2 ring-indigo-100 focus:border-indigo-400 outline-none" rows="2">${txt}</textarea>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${commentPresets[sc].map(p => `<button onclick="setComment(${sIdx}, ${cIdx}, '${p}')" class="px-2 py-1 rounded border text-[10px] hover:bg-indigo-50 hover:text-indigo-600 transition truncate max-w-[200px]">${p}</button>`).join('')}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function updateComment(sIdx, cIdx, txt) {
            const std = appData.students[sIdx];
            if(!std.comments) std.comments = [];
            const idx = std.comments.findIndex(c => c.item === cIdx);
            if(idx > -1) std.comments[idx].text = txt; else std.comments.push({item: cIdx, text: txt});
            autoSave();
        }
        function setComment(sIdx, cIdx, txt) { document.getElementById(`cmt-${sIdx}-${cIdx}`).value = txt; updateComment(sIdx, cIdx, txt); }

        // --- Data Update Helpers ---
        function updateScore(s, c, v) { appData.students[s].scores[c] = parseInt(v); renderAllAssessTables(); if(document.getElementById('assess-student-select').value == s) renderCommentForm(); autoSave(); }
        
        function updateDaysAttended(sIdx, val, shouldSave = true) {
            const days = parseInt(val) || 0;
            appData.students[sIdx].daysAttended = days;
            
            const total = parseInt(appData.settings.totalDays) || 200;
            const pct = Math.min(100, Math.round((days / total) * 100)); 
            
            appData.students[sIdx].attendance = pct.toString();
            
            const span = document.getElementById(`att-pct-${sIdx}`);
            if(span) span.innerText = `${pct}%`;
            
            if(shouldSave) autoSave();
        }

        function updateStudentField(s, f, v) { 
            appData.students[s][f] = v; 
            if(f==='name') { updateStudentSelect(); updateCommentStudentSelect(); renderStudentList(); }
            if(f==='actPass' || f==='charPass') renderGeneralTable();
            autoSave(); 
        }
        function addStudent() { 
            const total = parseInt(appData.settings.totalDays) || 200;
            const nextNum = appData.students.length > 0 ? Math.max(...appData.students.map(s => parseInt(s.number) || 0)) + 1 : 1;
            appData.students.push({
                id: Date.now(), 
                number: nextNum,
                studentId: "",
                prefix: "",
                firstname: "",
                lastname: "",
                name: "นักเรียนใหม่", 
                daysAttended: total, 
                attendance: "100", 
                scores: new Array(appData.competencies.length).fill(2), 
                actPass:true, 
                charPass:true, 
                comments:[]
            });
            renderAllAssessTables(); updateStudentSelect(); updateCommentStudentSelect(); renderStudentList(); autoSave();
        }
        function removeStudent(i) { if(confirm("ลบนักเรียนคนนี้?")) { appData.students.splice(i, 1); renderAllAssessTables(); updateStudentSelect(); updateCommentStudentSelect(); renderStudentList(); autoSave(); } }
        
        function updateStudentSelect() {
            const el = document.getElementById('report-student-select');
            el.innerHTML = '<option value="">-- เลือกนักเรียน --</option>' + appData.students.map((s,i) => `<option value="${i}">${s.name}</option>`).join('');
        }
        function updateCommentStudentSelect() {
            const el = document.getElementById('assess-student-select');
            const old = el.value;
            el.innerHTML = '<option value="">-- เลือกนักเรียน --</option>' + appData.students.map((s,i) => `<option value="${i}">${s.number || i+1}. ${s.name}</option>`).join('');
            el.value = old;
        }

        // --- Backup / Restore / Export ---
        function backupData() {
            autoSaveSettings(); 
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Report_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click(); URL.revokeObjectURL(url);
        }

        function handleRestore(e) {
            const file = e.target.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = function(evt) {
                try {
                    const d = JSON.parse(evt.target.result);
                    if(d.students && d.competencies) {
                        if(confirm("ยืนยันการกู้คืนข้อมูล? ข้อมูลปัจจุบันจะถูกแทนที่")) {
                            appData = d; 
                            // Re-render everything manually since we can't just reload
                            renderSettings();
                            renderCompetencyConfig();
                            renderAllAssessTables();
                            renderStudentList();
                            updateStudentSelect();
                            updateCommentStudentSelect();
                            renderDashboard();
                        }
                    } else alert("ไฟล์ไม่ถูกต้อง");
                } catch(err) { alert("เกิดข้อผิดพลาดในการอ่านไฟล์"); }
            };
            r.readAsText(file);
            e.target.value = '';
        }

        function exportToCSV() {
            autoSaveSettings();
            let csv = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Thai support
            
            // Header
            let header = ["เลขที่", "รหัส", "ชื่อ-สกุล", "เวลามาเรียน(%)", "วันมาเรียน"];
            appData.competencies.forEach((_, i) => header.push(`ข้อ ${i+1} (คะแนน)`));
            header.push("กิจกรรมพัฒนาผู้เรียน", "คุณลักษณะฯ", "หมายเหตุ");
            csv += header.join(",") + "\r\n";

            // Rows
            appData.students.forEach((s, i) => {
                let row = [s.number || i+1, s.studentId || "", `"${s.name}"`, s.attendance, s.daysAttended || ""];
                appData.competencies.forEach((_, ci) => row.push(s.scores[ci]||1));
                row.push(s.actPass?"ผ่าน":"ไม่ผ่าน", s.charPass?"ผ่าน":"ไม่ผ่าน", `"${s.remarks||''}"`);
                csv += row.join(",") + "\r\n";
            });

            const enc = encodeURI(csv);
            const link = document.createElement("a"); link.href = enc; link.download = `Report_Export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function resetData() {
            if(confirm("⚠️ คำเตือน: คุณต้องการล้างข้อมูลทั้งหมดใช่หรือไม่?\nการกระทำนี้ไม่สามารถย้อนกลับได้")) {
                location.reload(); // Simple reload clears everything since no localStorage
            }
        }

        function formatDate(dateStr) {
            if(!dateStr) return "";
            const date = new Date(dateStr);
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        // --- Print Logic (Render Report Card) ---
        function renderReportCard() {
            autoSaveSettings();
            const idx = document.getElementById('report-student-select').value;
            const area = document.getElementById('report-area');
            if(idx === "") { area.innerHTML = "<div class='text-center py-20 text-slate-400'>กรุณาเลือกนักเรียนเพื่อแสดงตัวอย่าง</div>"; return; }
            
            const s = appData.students[idx];
            const set = appData.settings;
            
            // Generate Rows
            let rows = appData.competencies.map((c, i) => {
                const sc = s.scores[i] || 1;
                const diff = sc - c.target;
                let res = diff >= 0 ? (diff==0 ? "<span class='text-blue-600 font-bold'>ตามเกณฑ์</span>" : "<span class='text-emerald-600 font-bold'>สูงกว่าเกณฑ์</span>") : "<span class='text-red-500 font-bold'>ควรปรับปรุง</span>";
                if(diff == -1) res = "<span class='text-orange-500 font-bold'>เข้าใกล้เกณฑ์</span>";
                
                return `<tr>
                    <td class="p-2 align-top border border-gray-700">${i+1}. ${c.title}</td>
                    <td class="p-2 text-center border border-gray-700 bg-slate-50">${levels[c.target]}</td>
                    <td class="p-2 text-center font-bold text-indigo-900 border border-gray-700">${levels[sc]}</td>
                    <td class="p-2 text-center text-xs border border-gray-700">${res}</td>
                </tr>`;
            }).join('');

            // Generate Comments
            let cmts = appData.competencies.map((_, i) => {
                const sc = s.scores[i] || 1;
                const c = s.comments ? s.comments.find(x => x.item === i) : null;
                const textToShow = (c && c.text) ? c.text : (commentPresets[sc] ? commentPresets[sc][0] : "-");
                
                return `<tr>
                    <td class="p-1 text-center w-10 align-top border border-gray-700">${i+1}</td>
                    <td class="p-1 text-center w-24 font-bold align-top border border-gray-700">${levels[sc]}</td>
                    <td class="p-1 pl-2 text-left align-top border border-gray-700">${textToShow}</td>
                </tr>`;
            }).join('');
            
            // Teachers Signature Layout
            let teacherSignatures = `
                <div class="mb-2 pb-10 border-b border-dotted border-slate-400 w-48 signature-line"></div>
                <div class="mb-1">(${set.teacher1 || '..........................................'})</div>
            `;
            if (set.teacher2) {
                teacherSignatures += `
                    <div class="mt-4 mb-2 pb-10 border-b border-dotted border-slate-400 w-48 signature-line"></div>
                    <div class="mb-1">(${set.teacher2})</div>
                `;
            }

            // HTML Structure
            area.innerHTML = `
                <div class="relative text-center mb-4">
                    ${set.logo ? `<img src="${set.logo}" class="absolute left-0 top-0 w-16 h-16 object-contain">` : ''}
                    <h1 class="text-xl font-bold text-slate-800">แบบรายงานผลการเรียนรู้รายปี</h1>
                    <h2 class="text-lg text-slate-700">ชั้น${set.class} ปีการศึกษา ${set.year}</h2>
                    <h3 class="text-base text-slate-600">${set.school}</h3>
                </div>
                
                <div class="flex justify-between items-end pb-2 mb-2 text-sm border-b border-gray-700">
                    <div class="space-y-1">
                        <div>ชื่อ-สกุล: <span class="font-bold text-xl ml-2 text-slate-800">${s.name}</span></div>
                        <div>เลขประจำตัว: <span class="font-bold text-lg ml-2 text-slate-700">${s.studentId || '-'}</span></div>
                    </div>
                    <div class="text-right">
                        <div>เวลาเรียน: <span class="font-bold text-lg">${s.attendance}%</span></div>
                        <div class="text-xs text-slate-500">(${s.daysAttended} วัน)</div>
                    </div>
                </div>

                <div class="mb-3">
                    <table class="w-full text-sm mb-3 border-collapse border border-gray-700">
                        <thead>
                            <tr class="bg-gray-100 text-slate-700">
                                <th class="p-2 text-left font-bold border border-gray-700">รายการสมรรถนะ</th>
                                <th class="p-2 w-24 text-center font-bold border border-gray-700">เป้าหมาย</th>
                                <th class="p-2 w-24 text-center font-bold border border-gray-700">ผลประเมิน</th>
                                <th class="p-2 w-28 text-center font-bold border border-gray-700">สรุป</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>

                <div class="flex gap-4 mb-4 text-sm">
                    <div class="flex-1 rounded border border-gray-700 p-2 bg-slate-50">
                        <div class="font-bold mb-2 text-slate-700 border-b border-gray-700 pb-1">กิจกรรมพัฒนาผู้เรียน</div>
                        <div class="flex gap-6 justify-center mt-2">
                            <label class="flex items-center gap-2">
                                <div class="w-4 h-4 border border-slate-700 rounded flex items-center justify-center ${s.actPass ? 'bg-indigo-600 border-indigo-600' : 'bg-white'}">
                                    ${s.actPass ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}
                                </div>
                                <span class="${s.actPass ? 'font-bold text-indigo-900' : 'text-slate-600'}">ผ่าน</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <div class="w-4 h-4 border border-slate-700 rounded flex items-center justify-center ${!s.actPass ? 'bg-red-500 border-red-500' : 'bg-white'}">
                                     ${!s.actPass ? '<i class="fas fa-times text-white text-[10px]"></i>' : ''}
                                </div>
                                <span class="${!s.actPass ? 'font-bold text-red-600' : 'text-slate-600'}">ไม่ผ่าน</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex-1 rounded border border-gray-700 p-2 bg-slate-50">
                        <div class="font-bold mb-2 text-slate-700 border-b border-gray-700 pb-1">คุณลักษณะอันพึงประสงค์</div>
                        <div class="flex gap-6 justify-center mt-2">
                             <label class="flex items-center gap-2">
                                <div class="w-4 h-4 border border-slate-700 rounded flex items-center justify-center ${s.charPass ? 'bg-indigo-600 border-indigo-600' : 'bg-white'}">
                                    ${s.charPass ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}
                                </div>
                                <span class="${s.charPass ? 'font-bold text-indigo-900' : 'text-slate-600'}">ผ่าน</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <div class="w-4 h-4 border border-slate-700 rounded flex items-center justify-center ${!s.charPass ? 'bg-red-500 border-red-500' : 'bg-white'}">
                                     ${!s.charPass ? '<i class="fas fa-times text-white text-[10px]"></i>' : ''}
                                </div>
                                <span class="${!s.charPass ? 'font-bold text-red-600' : 'text-slate-600'}">ไม่ผ่าน</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="font-bold text-sm mb-1 text-slate-700">ความเห็น/ข้อเสนอแนะเพิ่มเติม</h4>
                    <table class="w-full text-xs text-slate-600 border-collapse border border-gray-700">
                        ${cmts}
                    </table>
                </div>

                <div class="flex justify-around mt-12 text-sm text-center signature-section items-end">
                    <div>
                        ${teacherSignatures}
                        <div class="font-bold text-slate-800">ครูประจำชั้น</div>
                        <div class="mt-1 text-xs text-slate-500">วันที่ ${formatDate(set.date)}</div>
                    </div>
                    <div>
                        <div class="mb-2 pb-10 border-b border-dotted border-slate-400 w-48 signature-line"></div>
                        <div class="mb-1">(${set.director||'..........................................'})</div>
                        <div class="font-bold text-slate-800">ผู้อำนวยการสถานศึกษา</div>
                        <div class="mt-1 text-xs text-slate-500">วันที่ ${formatDate(set.date)}</div>
                    </div>
                </div>
            `;
        }
        
        // --- Google Sheets Logic ---
        function setupCloudConnection() {
            if (CONFIG_WEB_APP_URL) {
                alert("สถานะ: เชื่อมต่อ Web App URL แล้ว\n\nระบบจะบันทึกข้อมูลอัตโนมัติเมื่อมีการแก้ไข");
                triggerCloudAutoSave();
            } else {
                alert("ยังไม่ได้ตั้งค่า Web App URL\n\nกรุณาเปิดไฟล์ HTML และใส่ URL ที่ได้จาก Google Apps Script ลงในตัวแปร 'CONFIG_WEB_APP_URL'");
            }
        }

        async function saveToCloud(silent = false) {
            const url = CONFIG_WEB_APP_URL;
            if (!url) {
                updateCloudStatusUI(); // Show not configured state
                return;
            }

            // In Auto-Save mode, we skip confirmation
            if (!silent && !confirm("ยืนยันการบันทึกข้อมูลลง Google Sheets?")) return;
            
            // UI Updates
            if(silent) updateCloudStatusUI('saving');
            else {
                const btn = document.getElementById('btn-cloud-connect');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังส่ง...';
                btn.disabled = true;
            }
            
            try {
                // Send Data
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });
                
                if(silent) updateCloudStatusUI('saved');
                else alert("ส่งข้อมูลไปยัง Google Sheets แล้ว!");
                
            } catch (error) {
                console.error(error);
                if(silent) updateCloudStatusUI('error');
                else alert("เกิดข้อผิดพลาดในการส่งข้อมูล: " + error.message);
            } finally {
                if (!silent) {
                    const btn = document.getElementById('btn-cloud-connect');
                    btn.innerHTML = '<i class="fas fa-check-circle text-sm"></i> สถานะ Cloud';
                    btn.disabled = false;
                    updateCloudStatusUI('saved'); 
                }
            }
        }

        init();
    </script>
</body>
</html>